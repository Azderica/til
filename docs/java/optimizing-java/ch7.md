# 가비지 수집 고급

핫스팟 수집기에 대해 소개합니다.

<br/>

## 트레이드오프와 탈착형 수집기

개발자는 가비지 수집기 선정 시 다음 항목을 고려해야합니다.

- **중단 시간(중단 길이 또는 기간이라고도 합니다.)**
- 처리율(애플리케이션 런타임 대비 GC 시간)
- 중단 빈도(수집기 때문에 애플리케이션이 얼마나 자주 멈추는지)
- 회수 효율(GC 사이클 당 얼마나 많은 가비지가 수집되는지)
- 중단 일관성(중단 시간이 고른편입니다.)

성능 엔지니어는 수집기 선정 시 다양한 트레이드 오프와 관심사를 면밀히 검토해야합니다.

<br/>

## 동시 GC 이론

그래픽/애니메이션 디스플레이 시스템와 같은 특화된 시스템은 프레임률이 거의 고정되어 있어서 GC를 규칙적으로 수행할 수 있습니다.

> 적절한 계산이 지연되는 것은 사실 사소한 단점에 불과합니다. 정작 큰 문제는 가비지 수집이 언제 발생할지 예상할 수 없다는 점입니다.

최신 GC이론은 이러한 문제를 해결할려고 시도합니다.

### JVM 세이프포인트

핫스팟 병렬 수집기에서 STW 가비지 수집을 실행하려면 애플리케이션 스레드를 모두 중단시켜야합니다. JVM은 사실 완전히 선제적인 멀티스레드 환경이 아닙니다. OS 코어 기능처럼 JVM도 조정 작업이 필요합니다. 애플리케이션 스레드마다 **세이프포인트(안전점, safe point)**라는 특별한 지점을 둡니다. 세이프포인트는 스레드의 내부 자료 구조가 보이는 지점이며, 이때 어떤 작업을 하기 위해 스레드는 잠시 중단될 수 있습니다.

JVM은 다음 두가지 규칙에 따라 세이프포인트를 처리합니다.

- JVM은 강제로 스레드를 세이프포인트 상태로 바꿀 수 없습니다.
- JVM은 스레드가 세이프포인트 상태에서 벗어나지 못하게 할 수 있습니다.

따라서 세이프포인트 요청을 받았을 때 그 지점에서 스레드가 제어권을 반납하게 만드는 코드가 VM 인터프리터 구현체 어디에 잇어야합니다. 세이프포인트 상태로 바뀌는 경우는 다음과 같습니다.

- JVM이 전역을 세이프포인트 시간 플래그를 세팅합니다.
- 각 애플리케이션 스레드는 폴링을 하면서 이 플래그가 세팅됐는지 확인합니다.
- 애플리케이션 스레드는 일단 멈췄다가 다시 깨어날 때까지 대기합니다.

**세이프포인트 시간 플래그**를 세팅하면 모든 애플리케이션 스레드는 반드시 멈춰야합니다. 일반 애플리케이션 싀레드는 이런 식으로 풀링합니다.

다음의 경우, 스레드는 자동으로 세이프포인트 상태가 됩니다.

- 모니터에서 차단되는 경우
- JNI 코드를 실행하는 경우

다음의 경우, 스레드가 꼭 세이프포인트 상태가 되는 것은 아닙니다.

- 바이트코드를 실행하는 도중(인터프리티드 모드)
- OS가 인터럽트를 거는 경우

<br/>

## CMS

<br/>

## G1

<br/>

## 셰난도아

<br/>

## C4(아줄 징)

<br/>

## 밸런스트(IBM J9)

<br/>

## 레거시 핫스팟 수집기
